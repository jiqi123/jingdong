var krystal=window.krystal||{};window.krystal.cartKillTimer=null;krystal.cartSecKill=(function(){var a={noDefault:function(c){if(c&&c.preventDefault){c.preventDefault()}else{window.event.returnValue=false}return false},noPropagation:function(c){if(c&&c.stopPropagation){c.stopPropagation()}else{c.cancelBubble=true}}};var b={start:function(c){this.id=c.id||"#seckillul";this.childCls=c.childCls||".seckill-new-item";this.limitCount=c.limitCount||20;this.container=document.querySelector(this.id);this.timeRemain=c.timeRemain||0;this.hourId=c.hourId||"#killHour";this.minuteId=c.minuteId||"#killMin";this.secondId=c.secondId||"#killSec";this.computeCollectionWidth=c.computeCollectionWidth||null;this.computeTime();this.computeItemWidth(3.5);this.collectionIterator();this.makeItemsMove();this.bindEvt4Win()},computeTime:function(){var c=this;c.convertTime();clearInterval(krystal.cartKillTimer);krystal.cartKillTimer=setInterval(function(){c.convertTime();if(!c.timeRemain||c.timeRemain==0){c.getNewRound()}},1000)},getNewRound:function(){clearInterval(krystal.cartKillTimer);var c="/cart/miaoShaLayer.action";jQuery.get(c,function(e){if(e!=null&&e!=""){document.getElementById("secKillArea").innerHTML=e;var d=$("#timeRemain").val();krystal.cartSecKill.init({timeRemain:d})}})},convertTime:function(){this.timeRemain=this.timeRemain-1;if(this.timeRemain<=0){this.getNewRound();return false}var c=document.querySelector(this.hourId),f=document.querySelector(this.minuteId),h=document.querySelector(this.secondId),k=60,g=3600,j=1,e=Math.floor(this.timeRemain/g),i=Math.floor((this.timeRemain-e*g)/k),d=Math.floor((this.timeRemain-e*g-i*k)/j);c.innerHTML=this.doubleIt(e);f.innerHTML=this.doubleIt(i);h.innerHTML=this.doubleIt(d)},doubleIt:function(c){if(c<10){return"0"+c}else{return c}},computeItemWidth:function(c){if(c){this.itemWidth=(document.documentElement.clientWidth||document.body.clientWidth)/c;this.itemWidthstyle=(document.documentElement.clientWidth||document.body.clientWidth)/c+"px"}else{this.itemWidth=(document.documentElement.clientWidth||document.body.clientWidth)/3;this.itemWidthstyle="33.33%"}},collectionIterator:function(){var d=this;var f=0;d.collections=d.container.querySelectorAll(d.childCls);for(var e=0,c=d.collections.length;e<c;e++){(function(g){d.collections[g].style.width=d.itemWidthstyle;if(g>=d.limitCount){d.collections[g].style.display="none"}else{f+=d.itemWidth;var h=d.collections[g].querySelector(".seckill-new-link");h.addEventListener("click",d.JumpAndBuryPoint.bind(d,h))}})(e)}f&&(f+=document.querySelector(".seckill-all-item").offsetWidth);d.container.style.width=f+"px"},JumpAndBuryPoint:function(d){var c=d.dataset.wareid;setTimeout(function(){pingClick(cartUse,"MShopcart_EmptySecKill",c,"","","4")},0);setTimeout(function(){window.location.href=d.dataset.url},30)},makeItemsMove:function(){var e=this;var c=this.container.getBoundingClientRect().width||this.container.offsetWidth;var d=document.documentElement.clientWidth||document.body.clientWidth;e.maxMoveDis=Math.ceil(c-d);if(c<=d){return}this.container.removeEventListener("touchstart",this);this.container.removeEventListener("touchmove",this);this.container.removeEventListener("touchend",this);this.container.addEventListener("touchstart",this);this.container.addEventListener("touchmove",this);this.container.addEventListener("touchend",this)},handleEvent:function(c){switch(c.type){case"touchstart":this.startHandler(c);break;case"touchmove":this.moveHandler(c);break;case"touchend":this.endHandler(c);break}},startHandler:function(f){var g=this;g.objUnit={};g.objUnit.beginTime=+new Date;var d=g.container.style.transform||g.container.style.MozTransform||g.container.style.MsTransform||g.container.style.WebkitTransform;if(!d){d="translateX(0px)"}var e=/\d+(\.)?(\d+)?/;var c=d.match(e)[0];g.objUnit.translateDisStart=g.objUnit.tanslateDis=c?(-1)*parseInt(c):0;g.objUnit.startX=g.objUnit.x0=f.changedTouches[0].clientX;g.objUnit.startY=g.objUnit.y0=f.changedTouches[0].clientY},moveHandler:function(e){var f=this;var c=e.changedTouches[0].clientX;var d=e.changedTouches[0].clientY;if(Math.abs(d-f.objUnit.y0)>Math.abs(c-f.objUnit.x0)){return}f.objUnit.tanslateDis+=(c-f.objUnit.x0);f.objUnit.x0=c;if(f.objUnit.tanslateDis+150<=(f.maxMoveDis*(-1))){window.location.href="//ms.m.jd.com/seckill/seckillList"}f.setMoveDistance(f.objUnit.tanslateDis,"0s");a.noDefault(e)},endHandler:function(c){var d=this;d.objUnit.endTime=+new Date;d.objUnit.endX=c.changedTouches[0].clientX;d.objUnit.deltaDist=d.objUnit.endX-d.objUnit.startX;d.objUnit.deltaTime=d.objUnit.endTime-d.objUnit.beginTime;d.objUnit.speed=Math.abs(d.objUnit.deltaDist/d.objUnit.deltaTime);if(d.objUnit.speed>0.5){d.objUnit.translateDisStart+=(d.objUnit.deltaDist*2.5);d.setMoveDistance(d.objUnit.translateDisStart,"0.3s")}},setMoveDistance:function(c,d){var e=this;if(c>0){c=0}if(c+10<=(e.maxMoveDis*(-1))){c=(e.maxMoveDis*(-1)-10)}e.container.style.WebkitTransform="translateX("+c+"px)";e.container.style.transform="translateX("+c+"px)";e.container.style.transition=d+" all ease-out";e.container.style.WebkitTransition=d+" all ease-out"},bindEvt4Win:function(){var c=this;window.addEventListener("resize",function(){c.computeItemWidth(3.5);c.collectionIterator();c.makeItemsMove()})}};return{init:function(c){b.start(c)}}})();
